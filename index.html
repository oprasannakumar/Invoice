<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bill Backup</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial;
  background: #f5f5f5;
  padding: 20px;
}
form {
  max-width: 600px;
  background: #fff;
  margin: auto;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,.1);
}
label {
  font-weight: bold;
  display: block;
  margin-top: 10px;
}
input, button {
  width: 100%;
  height: 40px;
  margin-top: 5px;
  padding: 6px;
  box-sizing: border-box;
}

.item-row {
  border: 1px solid #ddd;
  padding: 12px;
  border-radius: 6px;
  margin-top: 10px;
}

.row { display: grid; grid-template-columns: 1fr; gap: 6px; }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

.add-btn { background: #28a745; color: #fff; margin-top: 10px; }
.delete-btn { background: #dc3545; color: #fff; margin-top: 6px; }
.submit-btn { background: #007bff; color: #fff; margin-top: 15px; }

button { border: none; cursor: pointer; }
</style>
</head>

<body>

<form onsubmit="submitBill(event)">
  <h3>Bill Backup</h3>

  <label>Date</label>
  <input type="date" id="date" required>

  <label>Shop Name</label>
  <input type="text" id="shop" required>

  <label>Invoice No</label>
  <input type="text" id="invoice" placeholder="Leave empty to auto-generate">

  <h4>Items</h4>
  <div id="items"></div>

  <button type="button" class="add-btn" onclick="addItem()">‚ûï Add Item</button>
  <button type="submit" class="submit-btn">üíæ Save Bill</button>
</form>

<!-- ‚úÖ Invoice Popup (HIDDEN INITIALLY) -->
<div id="invoicePopup" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:320px;
    text-align:center;
  ">
    <h3>Invoice Generated</h3>

    <input id="popupInvoice" readonly style="
      width:100%;
      height:38px;
      margin:10px 0;
      text-align:center;
      font-weight:bold;
    ">

    <button onclick="copyInvoiceHTML()" style="
      width:100%;
      background:#28a745;
      color:#fff;
      border:none;
      padding:8px;
      cursor:pointer;
    ">üìã Copy Invoice</button>

    <button onclick="closeInvoicePopup()" style="
      width:100%;
      background:#6c757d;
      color:#fff;
      border:none;
      padding:8px;
      margin-top:8px;
      cursor:pointer;
    ">Close</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyaqhCzL-9c0ZatEt9VFMGh1EwuFtYIRKvd4xyKKQqsCVnGoas0ZjHgWKzGYAVjOg-Dwg/exec";

/* yyyy-mm-dd ‚Üí dd/mm/yyyy */
function formatDate(d) {
  const [y, m, day] = d.split("-");
  return `${Number(day)}/${Number(m)}/${y}`;
}


/* Set today's date */
window.onload = () => {
  const t = new Date();
  date.value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
};

/* Add item */
function addItem() {
  const div = document.createElement("div");
  div.className = "item-row";
  div.innerHTML = `
    <div class="row">
      <input placeholder="Item Name" class="name" required>
    </div>
    <div class="row-2">
      <input type="number" step="any" placeholder="Quantity" class="qty" oninput="calc(this)">
      <input type="number" step="any" placeholder="Price" class="price" oninput="calc(this,'price')">
    </div>
    <div class="row">
      <input type="number" step="any" placeholder="Total" class="total" oninput="calc(this,'total')">
    </div>
    <button type="button" class="delete-btn" onclick="this.parentElement.remove()">‚ùå Delete Item</button>
  `;
  items.appendChild(div);
}

/* Calculation */
function calc(el, mode) {
  const row = el.closest(".item-row");
  const q = parseFloat(row.querySelector(".qty").value);
  const p = parseFloat(row.querySelector(".price").value);
  const t = parseFloat(row.querySelector(".total").value);
  if (!q) return;
  if (mode === "price" && p) row.querySelector(".total").value = (q*p).toFixed(2);
  if (mode === "total" && t) row.querySelector(".price").value = (t/q).toFixed(2);
}

/* Invoice generation (HTML only) */
function generateInvoiceHTML() {
  const n = new Date();
  return `INV-${String(n.getDate()).padStart(2,'0')}${String(n.getMonth()+1).padStart(2,'0')}${n.getFullYear()}-${String(n.getHours()).padStart(2,'0')}${String(n.getMinutes()).padStart(2,'0')}${String(n.getSeconds()).padStart(2,'0')}`;
}

/* Popup controls */
function showInvoicePopup(inv) {
  popupInvoice.value = inv;
  invoice.value = inv;
  invoicePopup.style.display = "flex";
}
function closeInvoicePopup() {
  invoicePopup.style.display = "none";
}
function copyInvoiceHTML() {
  popupInvoice.select();
  document.execCommand("copy");
  alert("Invoice copied ‚úÖ");
}

/* Submit */
function submitBill(e) {
  e.preventDefault();

  let inv = invoice.value.trim();
  if (!inv) {
    inv = generateInvoiceHTML();
    showInvoicePopup(inv);
  }

  const itemsData = [...document.querySelectorAll(".item-row")].map(r => ({
    name: r.querySelector(".name").value,
    qty: r.querySelector(".qty").value,
    price: r.querySelector(".price").value,
    total: r.querySelector(".total").value
  }));

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      date: formatDate(date.value),
      shop: shop.value,
      invoice: inv,
      items: itemsData
    })
  })
  .then(() => {
    alert("Bill saved successfully ‚úÖ");
    document.querySelector("form").reset();
    items.innerHTML = "";
    addItem();
  });
}

addItem();
</script>

</body>
</html>
